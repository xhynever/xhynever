2.1.1 记账处理
记账处理是账户系统的核心功能，该功能对性能的要求比较高，高并发下热点账户问题比较突出，资金的正确性也必须保证，并且根据业务不同，记账的分录也是五花八门，宜信支付结算账户系统如何应对这些问题，这里重点介绍下：

账户系统记账采用记账服务的概念，每个记账服务就是一个记账分录的模板，业务系统按照这个模板传入记账金额、账户号或者用户号等信息。
账户系统采用redis分布式锁，防止业务系统重复提交请求。设置记账订单防重表，按照请求单号和机构号对记账请求做幂等性校验。
采用复式记账法，按照会计规则按照借贷记录流水，有借必有贷。
记账处理时，更新账户余额后同步返回结果给业务系统，异步的处理记账流水。同时设置补偿机制，定时重试记账流水处理失败的订单，重试三次失败后报警人工介入。
记账规则处理，每个记账服务可以绑定一些记账规则，账户系统根据记账服务遍历其绑定的规则，顺序处理。
2.1.2 热点账户问题
热点账户问题是账户系统的痛点，也困扰了我们很久，这里着重说下。

-- 充值时的记账分录是:

借方：三方支付待清算账户（+）

贷方：个人余额账户（+）

当大量用户充值时，三方支付的待清算账户就是热点账户，频繁的增加余额。

-- 提现时的记账分录是:

借方：个人余额账户（-）

贷方：三方支付资产账户（-）

当大量用户提现时，三方支付的资产账户就是热点账户，频繁的减少余额。

--业务收服务费的记账分录是:

借方：个人账户（-）

贷方：商户服务费账户（+）

当大量向用户收取服务费时，商户服务费账户就是热点账户，会频繁增加余额。

--业务服务费付款的记账分录是:

借方：商户服务费账户（-）

贷方：个人账户（+）

当大量用服务费余额向用户付款时，商户服务费账户就是热点账户，会频繁减少余额。

记账时，所有涉及的账户余额都要做update更新，高并发情况下，当出现上述类型的热点账户时，由于数据库的行级锁，对同一账户的更新余额操作由并行变成串行，单个请求的响应时间变长，从而拖垮整个记账服务。

宜信支付结算账户系统针对上述问题做了如下处理：

我们把热点账户按照金额变动方向分为加频账户（余额增加频繁）、减频账户（余额扣减频繁）、双频账户（余额增加扣减均频繁）。

加频账户处理
准实时更新余额。先将金额变动插入临时表中，由定时任务按照一定频率汇总发生额，并更新账户余额，而后删除临时记录。当加频账户减钱余额不足时，主动去汇总发生额。这里需要考虑主动汇总发生额和定时任务处理的并发情况，我们在该定时任务执行时设置redis锁，防止并发，主动汇总时会去判断这个redis锁是否存在，如存在证明定时任务正在执行，无需主动汇总，可能是真的余额不足。主动汇总同样会设置redis锁，定时任务同样会判断。

减频账户处理
将减频账户拆分多个子账户，减频子账户设置金额报警，如果某个减频子账户余额不足触发报警，会对该子账户做资金归集，将其他子账户余额归集到该子账户（每个子账户设置可归集金额限制）。如在交易过程中发现该子账户余额不足，转向使用其他子账户记账。由于拆分子账户，余额查询时需要汇总各个子账户余额返回；记录主账户流水需要记账后余额，这里需要异步计算汇总。当减频账户加钱时，需要平均分配入账到不通的子账户。

双频账户处理
将双频账户拆分多个子账户。加钱时，准实时更新余额，先将子账户金额变动插入临时表中，由定时任务按一定频率汇总发生额，将汇总的发生额更新进对应的子账户，并删除金额变动记录；减钱按照之前减频账户的逻辑执行。

2.1.3 记账死锁问题
高并发情况下，当多个账户之前互相转账时，可能会出现死锁问题。

例如：A余额账户 —> B余额账户（线程1） 和 B余额账户—>A余额账户（线程2） 两个转账请求并发，账户系统对每个转账请求都会更新A、B余额，这两个更新需要在一个事务里，正常流程线程1先更新A，再更新B，线程2先更新B，再更新A，线程1更新完A后会等待B的锁，不提交事务，线程2更新完B后会等待A的锁，不提交事务，这样两个线程互相等待锁，造成死锁。

宜信支付结算账户系统针对这种情况提出了解决办法，对账户号进行排序后再更新余额，这样每个线程都是先更新A再更新B，解决了死锁问题。

2.2 账户系统存储层架构
宜信支付结算账户系统数据库采用Mysql，缓存采用redis。

Mysql数据库采用主从架构，一主二从，主库向从库同步数据。针对一些数据量大的表进行分表，比较有代表性的是账户流水表，既要按账户维度查询，又要按时间维度汇总，所以针对这个特点，冗余了一张表，一张按照账户分表，一张按照日期分表。
Redis采取集群架构，集群中每个点主备的形式。
2.3 账户系统的网络层架构
账户系统各个服务部署在同一机房，其中记账子系统和异步记账模块部署在4个不同的物理机上，其他子系统和模块部署在2个不同物理机上。最前端采用nginx实现负载均衡。